## Exploratory Data Analysis

```{r, include=FALSE}
train <- read.csv("../data/raw/bank_marketing_train.csv")
```

```{r}
datatable(head(train, 100), options = list(scrollX = TRUE))
str(train)
attach(train)
```

### Variable descriptions
#### Bank client data:
1. `X` (Integer): id of customer
2. `age` (Integer): age of the customer
3. `job` (Categorical): occupation
4. `marital` (Categorical): marital status
5. `education` (Categorical): education level
6. `default` (Binary): has credit in default?
7. `housing` (Binary): has housing loan?
8. `loan` (Binary): has personal loan?
9. `contact` (Categorical): contact communication type
10. `month` (Categorical): last contact month of year
11. `day_of_week` (Integer): last contact day of the week
12. `duration` (Integer): last contact duration, in seconds (numeric). Important note: this attribute highly affects the output target (e.g., if duration=0 then y='no'). Yet, the duration is not known before a call is performed. Also, after the end of the call y is obviously known. Thus, this input should only be included for benchmark purposes and should be discarded if the intention is to have a realistic predictive model

#### Other attributes:
13. `campaign` (Integer): number of contacts performed during this campaign and for this client (numeric, includes last contact)
14. `pdays` (Integer): number of days that passed by after the client was last contacted from a previous campaign (numeric; -1 means client was not previously contacted)
15. `previous` (Integer): number of contacts performed before this campaign and for this client
16. `poutcome` (Categorical): outcome of the previous marketing campaign (categorical: 'failure','nonexistent','success')

#### Social and economic context attributes
17. `emp.var.rate` (Integer): employment variation rate - quarterly indicator
18. `cons.price.idx` (Integer): consumer price index - monthly indicator
19. `cons.conf.idx` (Integer): consumer confidence index - monthly indicator
20. `euribor3m` (Integer): euribor 3 month rate - daily indicator
21. `nr.employed` (Integer): number of employees - quarterly indicator

#### Output variable (desired target)
22. `subscribed` (Binary): has the client subscribed a term deposit?

Source: [UCI Machine Learning Repository](https://archive.ics.uci.edu/dataset/222/bank+marketing)

```{r}
vis_dat(train)
skim(train)
```

```{r}
plot_ly(train, x = subscribed, type = 'histogram')

corrplot(cor(train[, c("X", "age", "duration", "campaign", "pdays", "previous", "emp.var.rate", "cons.price.idx", "cons.conf.idx", "euribor3m", "nr.employed")]), method="pie")
```

```{r}
plot_ly(train, x = job, y = age, type = 'box', color = job)

plot_ly(train, x = education, y = age, type = 'box', color = education)
```


```{r}
eduResp <- ggplot(train, aes(x = education, fill = factor(subscribed))) +
  geom_bar(position = "fill") +
  coord_flip() +
  ylab("Proportion") +
  scale_fill_discrete(name = "Subscribed") +
  xlab("Education") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

eduFreq <- ggplot(as.data.frame(table(education)/sum(table(education))*100), aes(x = reorder(education, Freq), y = Freq)) +
  geom_bar(stat = "identity", color = "gray",  fill = "steelblue", alpha=0.9) +  
  coord_flip() +
  labs(title = "Education", x = "Education Level", y = "Count") +
  theme_minimal()

eduFreq / eduResp

ggplot(train, aes(x = poutcome, fill = factor(subscribed))) +
  geom_bar(position = "fill") +
  ylab("Proportion") +
  scale_fill_discrete(name = "Subscribed") +
  xlab("Outcome of previous campaign") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  theme_minimal() +
  geom_text(
    data = transform(as.data.frame(table(train$poutcome)),
                     poutcome = Var1,
                     label = paste0(round(100 * Freq / sum(Freq), 1), "%")),
    aes(x = poutcome, y = 1.05, label = label),
    inherit.aes = FALSE
  )

ggplot(train, aes(age)) + geom_histogram(binwidth=4,position="fill",aes(fill=factor(subscribed)))+scale_fill_discrete(name="Subscribed")+ylab("proportion")+geom_hline(yintercept=0.5)

ggplot(train, aes(x = job, fill = factor(subscribed))) +
  geom_bar(position = "fill") +
  ylab("Proportion") +
  scale_fill_discrete(name = "Subscribed") +
  xlab("Job") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  geom_text(
    data = transform(as.data.frame(table(train$job)),
                     job = Var1,
                     label = paste0(round(100 * Freq / sum(Freq), 1), "%")),
    aes(x = job, y = 1.05, label = label),
    inherit.aes = FALSE
  )

ggplot(train, aes(cons.price.idx)) + geom_histogram(binwidth=2,position="fill",aes(fill=factor(subscribed)))+scale_fill_discrete(name="Subscribed")+ylab("proportion")+geom_hline(yintercept=0.5)

ggplot(train, aes(cons.conf.idx)) + geom_histogram(binwidth=3,position="fill",aes(fill=factor(subscribed)))+scale_fill_discrete(name="Subscribed")+ylab("proportion")+geom_hline(yintercept=0.5)

ggplot(train, aes(euribor3m)) + geom_histogram(binwidth=3,position="fill",aes(fill=factor(subscribed)))+scale_fill_discrete(name="Subscribed")+ylab("proportion")+geom_hline(yintercept=0.5)

train$emp_cat <- ifelse(train$emp.var.rate < 0, "Negative", "Positive or Zero")

ggplot(train, aes(x = emp_cat, fill = factor(subscribed))) +
  geom_bar(position = "fill") +
  ylab("Proportion") +
  scale_fill_discrete(name = "Subscribed") +
  xlab("Employment Variation (Â±)") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  theme_minimal() +
  geom_text(
    data = {
      df <- as.data.frame(table(train$emp_cat))
      names(df) <- c("emp_cat", "Freq")
      df$label <- paste0(round(100 * df$Freq / sum(df$Freq), 1), "%")
      df$y <- 1.05
      df
    },
    aes(x = emp_cat, y = y, label = label),
    inherit.aes = FALSE
  )

ggplot(train, aes(x = default, fill = factor(subscribed))) +
  geom_bar(position = "fill") +
  ylab("Proportion") +
  scale_fill_discrete(name = "Subscribed") +
  xlab("Default") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  theme_minimal() +
  geom_text(
    data = transform(as.data.frame(table(train$default)),
                     default = Var1,
                     label = paste0(round(100 * Freq / sum(Freq), 1), "%")),
    aes(x = default, y = 1.05, label = label),
    inherit.aes = FALSE
  )
```

```{r}
ggpairs(train[, c("age", "duration", "campaign", "pdays", "previous", "emp.var.rate", "cons.price.idx", "cons.conf.idx", "euribor3m", "nr.employed")], columns = 1:10, 
                 lower = list(continuous = wrap("points", alpha = 0.5, color = "darkred", size=0.5)),
                 title='Scatterplot', axisLabels='none')
```
