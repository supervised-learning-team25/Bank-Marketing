## Exploratory Data Analysis

```{r echo=FALSE}
source("../R/EDA_functions.R")
```

```{r echo=FALSE}
train <- read.csv("../data/raw/bank_marketing_train.csv")
train <- train %>% select(-X)
attach(train)
```

```{r echo=FALSE}
datatable(head(train, 100), options = list(scrollX = TRUE))
```

### Variable descriptions
#### Bank client data: {-}
1. `age` (Integer): age of the customer
2. `job` (Categorical): occupation
3. `marital` (Categorical): marital status
4. `education` (Categorical): education level
5. `default` (Binary): has credit in default?
6. `housing` (Binary): has housing loan?
7. `loan` (Binary): has personal loan?
8. `contact` (Categorical): contact communication type
9. `month` (Categorical): last contact month of year
10. `day_of_week` (Integer): last contact day of the week
11. `duration` (Integer): last contact duration, in seconds (numeric). Important note: this attribute highly affects the output target (e.g., if duration=0 then y='no'). Yet, the duration is not known before a call is performed. Also, after the end of the call y is obviously known. Thus, this input should only be included for benchmark purposes and should be discarded if the intention is to have a realistic predictive model

#### Other attributes: {-}
12. `campaign` (Integer): number of contacts performed during this campaign and for this client (numeric, includes last contact)
13. `pdays` (Integer): number of days that passed by after the client was last contacted from a previous campaign (numeric; -1 means client was not previously contacted)
14. `previous` (Integer): number of contacts performed before this campaign and for this client
15. `poutcome` (Categorical): outcome of the previous marketing campaign (categorical: 'failure','nonexistent','success')

#### Social and economic context attributes: {-}
16. [`emp.var.rate`](https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:Employment_rate) (Integer): employment variation rate - quarterly indicator
17. [`cons.price.idx`](https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:Consumer_price_index_(CPI)) (Integer): consumer price index - monthly indicator
18. [`cons.conf.idx`](https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:Business_and_consumer_confidence) (Integer): consumer confidence index - monthly indicator
19. [`euribor3m`](https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:EURIBOR) (Integer): euribor 3 month rate - daily indicator
20. [`nr.employed`](https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:Number_of_employees_-_EBS) (Integer): number of employees - quarterly indicator

#### Output variable (desired target): {-}
21. `subscribed` (Binary): has the client subscribed a term deposit?

Source: [UCI Machine Learning Repository](https://archive.ics.uci.edu/dataset/222/bank+marketing)

> **Note**: In our dataset there isn't the bank `balance` variable

#### More details {-}

```{r echo=FALSE}
skim(train)
```

The dataset includes 21 variables and 32,950 rows, with **no missing values**.  
Categorical variables like **job** and **education** show good diversity, while **default**, **loan**, and **housing** have only 3 unique values.

Among numeric variables, **age** has a fairly normal distribution (*mean ≈ 40*, *sd ≈ 10*), while **duration** and **pdays** are highly skewed, with extreme values up to 4918 and 999 respectively.  
Some variables (e.g., **campaign**, **previous**) have a low median but long tails, indicating that most observations are clustered at low values.    
Macroeconomic variables such as **emp.var.rate**, **euribor3m**, and **nr.employed** are more stable, with tight interquartile ranges, suggesting consistent economic conditions during data collection.

### Analysis of distributions

```{r warning=FALSE, echo=FALSE}
plot_ly(train, x = ~subscribed, type = 'histogram') %>%
  layout(title = "Number of subscribed")
```

Firstly we see that this dataset are **unbaleanced**, with the majority of people that have not subscribed.

#### Correlation and Pairwise Relationships {-}

<div class="hscroll-plot" style="height: 625px;">
<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
corrplot(cor(train[, c("age", "duration", "campaign", "pdays", "previous", "emp.var.rate", "cons.price.idx", "cons.conf.idx", "euribor3m", "nr.employed")]), method="pie")
```
<div class="plot-text">
<strong style="color: #317eac">Correlation Matrix</strong><br>
The correlation matrix reveals clear patterns among the numerical variables. Notably, <strong>euribor3m</strong>, <strong>nr.employed</strong>, and <strong>emp.var.rate</strong> are strongly positively correlated with each other, these suggest these variables capture similar information about the economic environment. This should be taken into account in predictive modeling, as using them together could lead to <strong>multicollinearity</strong>. In contrast, variables like <strong>campaign</strong>, <strong>pdays</strong>, and <strong>previous</strong> show very weak correlations with most other features, indicating they may contribute more independently to the model.
</div>
</div>

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
ggpairs(train[, c("age", "duration", "campaign", "pdays", "previous", "emp.var.rate", "cons.price.idx", "cons.conf.idx", "euribor3m", "nr.employed")], columns = 1:10, 
                 lower = list(continuous = wrap("points", alpha = 0.5, color = "darkred", size=0.5)),
                 title='Scatterplot', axisLabels='none')
```
<div class="plot-text">
<strong style="color: #317eac">Scatterplot Matrix</strong><br>
The scatterplot matrix confirms the <strong>distribution shape and linearity</strong> of relationships among the numeric variables. Several variables, such as <strong>duration</strong> and <strong>pdays</strong>, show <strong>highly skewed distributions</strong>, which could influence model performance and may benefit from transformations (e.g., log or binning). 
While some variables exhibit linear trends (e.g., euribor3m vs nr.employed), many scatterplots show dispersed or nonlinear patterns. This suggests that simple linear models may not fully capture the complexity in the data.
</div>
</div>

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
ggpairs(train[, c("age", "duration", "campaign", "pdays", "previous", "emp.var.rate", "cons.price.idx", "cons.conf.idx", "euribor3m", "nr.employed")], columns = 1:10,  aes(colour = as.factor(subscribed)),
                 lower = list(continuous = wrap("points", alpha = 0.5, size=0.5)),
                 title='Scatterplot by Target', axisLabels='none')
```
</div>
</div>
</div>

#### Distribution of Age across Different Education Levels and Jobs {-}

```{r warning=FALSE, echo=FALSE}
plot_ly(train, x = ~job, y = ~age, type = 'box', color = ~job) %>%
  layout(
    title = "Box plot: Age-Job",
    yaxis = list(title = "Age")
  ) %>% layout(hovermode='x')
```

As we can see, the age distribution is not similar across different job categories, exspecially for student that are younger than other categories and for retired that are older than other categories and have a wider range of ages, with some low value that may be disabled people.

```{r warning=FALSE, echo=FALSE}
plot_ly(train, x = ~education, y = ~age, type = 'box', color = ~education) %>%
  layout(
    title = "Box plot: Age-Education",
    yaxis = list(title = "Age")
  ) %>% layout(hovermode='x')
```

Instead, with the education level, people that are more educated are younger than people that are less educated. This is probably due to the fact that people that are more educated spend more time studying and less time working.

#### Client data {-}

<div class="hscroll-plot">
```{r warning=FALSE, echo=FALSE, fig.width=7, fig.height=5}
ageVar <- propResp(train, age, "Age", 4, 30)
jobVar <- freqRespOnSubscribed(train, job, "Job")
eduVar <- freqRespOnSubscribed(train, education, "Education")
```

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(ageVar)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Age</strong><br>
The age distribution is right-skewed, with a peak around 30–40 years old.  The proportion of people that have subscribed is higher among those over 60.This may be due to greater financial stability in older age groups.
</div>
</div>

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(jobVar)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Job</strong><br>
The distribution of the occupation is not uniform, with the majority of people that are admin. The proportion of people that have subscribed is among the higest between all the occupation. This is probably due to the fact that people that are admin have a higher income and are more likely to subscribe. While student and retired people have a higher proportion of subscription, this explain that we saw in the previous plot that the older people and the people with higher education level are more likely to subscribe.
</div>
</div>

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(eduVar)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Education</strong><br>
About Education Level, we can see that the distribution of the education level is not uniform, with the majority of people that have a university degree. The proportion of people that have a university degree and that have subscribed is among the higest between all the education level. 
This is probably due to the fact that people that have a university degree have a higher income and are more likely to subscribe.
</div>
</div>
</div>

#### Previous Campaign Data {-}

<div class="hscroll-plot" style="height: 450px;">
```{r warning=FALSE, echo=FALSE, fig.width=7, fig.height=5}
previousVar <- freqRespOnSubscribed(train, previous, "Number of calls previous campain")
poutcomeVar <- freqRespOnSubscribed(train, poutcome, "Poutcome")
```

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(previousVar)
```
</div>
<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(poutcomeVar)
```
</div>
</div>
<div class="plot-text">
<strong style="color: #317eac">Distribution of Contacts</strong><br>
About previous campaign, while most clients were not previously contacted, the success rate is visibly higher among those who were previously contacted more than once or had a successful prior outcome. This suggests that prior engagement is positively associated with subscription, but they are a small part of sample.
</div>

#### Temporal data {-}

<div class="hscroll-plot">
```{r warning=FALSE, echo=FALSE, fig.width=7, fig.height=5}
dayVar <- freqRespOnSubscribed(train, day_of_week, "Day of Week", c("mon", "tue", "wed", "thu", "fri"))
monthVar <- freqRespOnSubscribed(train, month, "Month", c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"))
durationVar <- propResp(train, duration, "Duration", 4, 100)
```

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(dayVar)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Days of Week</strong><br>
The distribution of the last contact day of the week is uniform, with the majority of people that have been contacted on Thursday. The proportion of people that have subscribed is among the higest when the last contact day of the week is on the middle of week.
</div>
</div>

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(monthVar)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Months</strong><br>
Instead, the distribution of the last contact month of the year is not uniform, with the majority of people that have been contacted in May. The proportion of people that have subscribed is among the higest when the last contact month of the year is in March, December, September and October. This is probably due to the fact that people are more likely to subscribe when they have more money and not during the summer.
</div>
</div>

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(durationVar)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Duration</strong><br>
The duration of the last contact is right-skewed, with a peak around 0-100 seconds. The proportion of people that have subscribed is higher among people that have been contacted for a longer duration. This is probably due to the fact that people that have been contacted for a longer duration are more interested to subscribe.
</div>
</div>
</div>

#### Social and economic data {-}

<div class="hscroll-plot">
```{r warning=FALSE, echo=FALSE, fig.width=7, fig.height=5}
cpiVar <- propResp(train, cons.price.idx, "Consumer Price Index", 2)

train$emp_cat <- ifelse(train$emp.var.rate < 0, "Negative", "Positive or Zero")
evrVar <- freqRespOnSubscribed(train, emp_cat, "Employment Variation (±)")

cciVar <- propResp(train, cons.conf.idx, "Consumer Confidence Index", 3)
eb3Var <- propResp(train, euribor3m, "Euribor 3 month rate", 3)
```

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(evrVar)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Employment Variation</strong><br>
The distribution of the employment variation rate is not uniform, with the majority of people that have a positive or zero employment variation rate. The proportion of people that have subscribed is among the higest when the employment variation rate is negative. This is probably due to the fact that people are more propensity to subscribe when they are in recession.
</div>
</div>

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(cpiVar)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Days of Consumer Price Index</strong><br>
The proportion of people that have subscribed is higher when the CPI is lower than 93. This is probably due to the fact that people when the CPI is lower have more money and are more likely to subscribe.
</div>
</div>

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(cciVar)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Consumer Confidence Index</strong><br>
The proportion of people that have subscribed is higher when the consumer confidence index is higher than -40. This is probably due to the fact that people when the consumer confidence index is higher have more money and have more propensity to subscribe.
</div>
</div>

<div class='plot-container'>
```{r warning=FALSE, echo=FALSE}
print(eb3Var)
```
<div class="plot-text">
<strong style="color: #317eac">Distribution of Euribor 3 month rate</strong><br>
When considering the Euribor rate, one might think that a lower Euribor would result in a decline in savings rate since most European banks align their deposit interest rate offers with ECB indexes, particularly with the three month Euribor. Still, as we see, this plot shows the opposite, with a lower Euribor corresponding to a higher probability for deposit subscription, and the same probability decreasing along with the increase of the three month Euribor.
</div>
</div>
</div>

### Conclusion
In conclusion, the analysis reveals several key insights about the factors influencing the likelihood of subscription in this dataset. First, the **data is unbalanced**, with the majority of individuals not subscribing to the service. **Age** plays a significant role, with older individuals, particularly those over 60, being more likely to subscribe, potentially due to greater financial stability. **Occupation** and **education** level also appear to influence subscription, with people in administrative roles and those with higher education showing higher subscription rates, likely due to higher income and greater financial stability.

**Previous engagement** with the campaign positively correlates with subscription, especially for individuals contacted multiple times or who had a successful outcome in prior campaigns. Additionally, the **timing of the contact** seems to affect subscription rates, with the highest rates observed in March, December, September, and October, and a higher likelihood of subscription when the **contact duration** is longer.

Economic factors, such as the **Consumer Price Index (CPI)**, **employment variation rate**, **consumer confidence index**, and **Euribor rate**, all show significant associations with subscription rates. A lower CPI, negative employment variation rate, and a higher consumer confidence index tend to be linked to higher subscription rates, reflecting the impact of financial conditions on consumer behavior.

Overall, the analysis suggests that financial stability, previous engagement, and certain economic factors are key drivers of subscription, while factors like age, occupation, and education level also influence the likelihood of subscribing.